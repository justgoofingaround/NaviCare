<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NaviCare ‚Ä¢ Insurance</title>

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">


  <style>
    .plan-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-weight:600;background:rgba(255,255,255,.06)}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .small-table{width:100%;border-collapse:collapse;margin-top:8px}
    .small-table td{padding:6px 4px;border-bottom:1px solid rgba(255,255,255,.1)}
    .small-table td:first-child{opacity:.8}
    .empty{display:flex;flex-direction:column;gap:6px}
  </style>
</head>
<body>
  <!-- Navbar -->
  <header class="nc-header">
    <div class="container">
      <div class="nc-bar">
        <a class="brand" href="dashboard.html">ü©∫ NaviCare</a>
        <nav class="nc-nav">
          <a href="dashboard.html">Intake</a>
          <a href="providers.html">Providers</a>
          <a href="insurance.html" class="active">Insurance</a>
          <a href="pharmacy.html">Pharmacy</a>
          <a href="about.html">About</a>
        </nav>
        <div class="small">Welcome, <b>test_user</b></div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h1>Insurance Coverage</h1>
      <p class="small">Review your health plan details and coverage information.</p>
    </section>

    <section id="plan-section" class="section card">
      <h2>Plan Summary</h2>
      <div id="plan-info" class="plan-grid"></div>
    </section>

    <section id="details-section" class="section card">
      <h2>Coverage Details</h2>
      <table class="small-table" id="coverage-table"></table>
    </section>

    <!-- Empty-state -->
    <section class="section card" id="empty-state" style="display:none">
      <div class="empty">
        <h2>No active journey</h2>
        <p class="small">Start with Intake to load your insurance details.</p>
        <div class="actions">
          <button class="btn" onclick="location.href='dashboard.html'">Go to Intake</button>
          <a class="btn outline" href="providers.html">View Providers</a>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container small">¬© NaviCare ‚Ä¢ Demo build</div>
  </footer>

  <!-- Scripts -->
  <script src="../js/app.js"></script>
  <script src="../js/state.js?v=1"></script>
  <script src="../js/mock-data.js?v=3"></script>
  <script src="../js/api-service.js?v=7"></script>

  <script>
    const planInfo = document.getElementById('plan-info');
    const coverageTable = document.getElementById('coverage-table');
    const emptyState = document.getElementById('empty-state');

    function renderCoverage(cov){
      console.log('üé® Rendering coverage in insurance page:', cov);
      
      // Ensure we have default values for missing properties
      const coverage = {
        plan: cov.plan || 'Unknown Plan',
        memberId: cov.memberId || 'MEMBER-12345',
        planType: cov.planType || 'PPO',
        tier: cov.tier || 'Silver',
        effectiveDate: cov.effectiveDate || new Date().toLocaleDateString(),
        service: cov.service || 'Specialist Visit',
        covered: cov.covered !== undefined ? cov.covered : true,
        copay: cov.copay || '$30',
        deductibleRemaining: cov.deductibleRemaining || cov.deductible || '$1,500',
        coinsurance: cov.coinsurance || '20%',
        oopMax: cov.oopMax || '$8,000',
        pcpCopay: cov.pcpCopay || '$25',
        specialistCopay: cov.specialistCopay || cov.copay || '$50',
        telehealthCopay: cov.telehealthCopay || '$25',
        erCopay: cov.erCopay || '$300',
        urgentCareCopay: cov.urgentCareCopay || '$100',
        imagingCost: cov.imagingCost || 'Covered after deductible',
        labCost: cov.labCost || 'Covered after deductible',
        preventiveCareCovered: cov.preventiveCareCovered || '100% covered',
        mentalHealthCopay: cov.mentalHealthCopay || '$50',
        rehabTherapyLimit: cov.rehabTherapyLimit || '20 visits per year',
        chiropracticLimit: cov.chiropracticLimit || '12 visits per year',
        referralRequired: cov.referralRequired !== undefined ? cov.referralRequired : false,
        outOfNetworkCoverage: cov.outOfNetworkCoverage || '50% after deductible',
        notes: cov.notes || ['Standard coverage plan', 'Contact customer service for details']
      };
      
      planInfo.innerHTML = `
        <div class="card small">
          <h3>${coverage.plan}</h3>
          <div class="meta">
            <span class="pill"><i class="fa-solid fa-id-card"></i>${coverage.memberId}</span>
            <span class="pill"><i class="fa-solid fa-suitcase-medical"></i>${coverage.planType}</span>
            <span class="pill"><i class="fa-solid fa-circle-info"></i>${coverage.tier}</span>
          </div>
          <p class="small" style="margin-top:6px">Effective: ${coverage.effectiveDate}</p>
          <p class="small">${coverage.service} ‚Äî ${coverage.covered ? "‚úÖ Covered" : "‚ùå Not covered"} (${coverage.copay} copay)</p>
        </div>
      `;

      const rows = [
        ["Deductible Remaining", coverage.deductibleRemaining],
        ["Coinsurance", coverage.coinsurance],
        ["Out-of-Pocket Max", coverage.oopMax],
        ["PCP Copay", coverage.pcpCopay],
        ["Specialist Copay", coverage.specialistCopay],
        ["Telehealth Copay", coverage.telehealthCopay],
        ["ER Copay", coverage.erCopay],
        ["Urgent Care Copay", coverage.urgentCareCopay],
        ["Imaging", coverage.imagingCost],
        ["Labs", coverage.labCost],
        ["Preventive Care", coverage.preventiveCareCovered],
        ["Mental Health", coverage.mentalHealthCopay],
        ["Rehab Therapy Limit", coverage.rehabTherapyLimit],
        ["Chiropractic Limit", coverage.chiropracticLimit],
        ["Referral Required", coverage.referralRequired ? "Yes" : "No"],
        ["Out-of-Network Coverage", coverage.outOfNetworkCoverage]
      ];

      coverageTable.innerHTML = rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join('') +
        `<tr><td colspan="2" style="padding-top:10px;opacity:.8"><b>Notes:</b><br>${coverage.notes.map(n=>"‚Ä¢ "+n).join("<br>")}</td></tr>`;
    }

    function loadCoverage(){
      console.log('üìã Loading coverage data...');
      console.log('NC state:', NC?.state);
      
      // Try to load from stored state first
      if (NC?.state?.results?.coverage) {
        console.log('‚úÖ Found coverage in state:', NC.state.results.coverage);
        renderCoverage(NC.state.results.coverage);
      } else {
        console.log('‚ö†Ô∏è No coverage found in state, loading from API...');
        // Load from API
        loadCoverageFromAPI();
      }
    }

    async function loadCoverageFromAPI() {
      console.log('üè• Loading coverage from Django insurance backend...');
      
      try {
        // Direct API call to Django backend for insurance plans
        const healthResponse = await fetch('http://localhost:8001/api/health/');
        
        if (healthResponse.ok) {
          console.log('‚úÖ Django insurance backend is healthy');
          
          const plansResponse = await fetch('http://localhost:8001/api/plans/');
          
          if (plansResponse.ok) {
            const plansData = await plansResponse.json();
            const plans = plansData.results || plansData;
            
            if (plans && plans.length > 0) {
              const firstPlan = plans[0];
              console.log('üéØ Using plan for coverage details:', firstPlan);
              
              // Convert Django plan data to coverage format
              const coverage = {
                plan: `${firstPlan.carrier.name} ${firstPlan.plan_name}`,
                service: "Specialist Visit",
                covered: true,
                copay: `$${firstPlan.specialist_copay}`,
                memberId: "MEMBER-" + Math.random().toString(36).substr(2, 9).toUpperCase(),
                planType: firstPlan.plan_type,
                tier: firstPlan.tier,
                effectiveDate: firstPlan.effective_date || new Date().toLocaleDateString(),
                deductibleRemaining: `$${firstPlan.annual_deductible}`,
                coinsurance: `${firstPlan.coinsurance_percentage}%`,
                oopMax: `$${firstPlan.max_out_of_pocket}`,
                pcpCopay: `$${firstPlan.pcp_copay}`,
                specialistCopay: `$${firstPlan.specialist_copay}`,
                telehealthCopay: `$${firstPlan.pcp_copay}`,
                erCopay: `$${firstPlan.er_copay}`,
                urgentCareCopay: `$${firstPlan.urgent_care_copay}`,
                imagingCost: "Covered after deductible",
                labCost: "Covered after deductible", 
                preventiveCareCovered: "100% covered",
                mentalHealthCopay: `$${firstPlan.specialist_copay}`,
                rehabTherapyLimit: "20 visits per year",
                chiropracticLimit: "12 visits per year",
                referralRequired: firstPlan.requires_referrals,
                outOfNetworkCoverage: firstPlan.out_of_network_coverage ? "50% after deductible" : "Not covered",
                notes: [
                  `${firstPlan.plan_type} plan with ${firstPlan.tier.toLowerCase()} tier coverage`,
                  `Monthly Premium: $${firstPlan.monthly_premium}`,
                  `Effective Date: ${firstPlan.effective_date || new Date().toLocaleDateString()}`
                ]
              };
              
              console.log('‚úÖ Successfully loaded real insurance coverage data');
              renderCoverage(coverage);
              return;
            }
          }
        }
        
        console.log('‚ö†Ô∏è Django backend not available - using mock data');
        throw new Error('Django backend unavailable');
        
      } catch (error) {
        console.error('Error loading coverage from Django insurance backend:', error);
        
        // Show insurance-specific warning since Django backend is specifically for insurance data
        showInsuranceBackendWarning();
        
        // Fallback to mock data
        const cov = (typeof MOCK_COVERAGE_PLUS === 'function' ? MOCK_COVERAGE_PLUS() : MOCK_COVERAGE());
        renderCoverage(cov);
      }
    }

    function showInsuranceBackendWarning() {
      const warningMsg = `
        <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; 
             border-radius: 8px; padding: 15px; margin: 20px 0; color: #856404;">
          <h4 style="margin: 0 0 10px 0; color: #856404;">
            üìã Demo Insurance Data
          </h4>
          <p style="margin: 0; font-size: 14px;">
            Django insurance backend is not running. Using sample coverage data for demonstration.
            <br><strong>To access real insurance data:</strong> Start the Django backend server.
          </p>
        </div>
      `;
      
      // Insert warning at the top of the main content
      const mainContent = document.querySelector('.coverage-view') || document.body;
      if (mainContent && !document.querySelector('.insurance-demo-warning')) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'insurance-demo-warning';
        warningDiv.innerHTML = warningMsg;
        mainContent.insertBefore(warningDiv, mainContent.firstChild);
      }
    }

    // render or empty
    if (NC && NC.requireIntake && NC.requireIntake()) {
      loadCoverage();
    } else {
      emptyState.style.display = 'block';
    }
  </script>
</body>
</html>
